version: "3.9"

x-api-base: &api-base
  image: api-server
  build:
    context: ./api
    dockerfile: src/main/docker/dev-jvm.dockerfile
  depends_on:
    - main_db
    - firebase-emulator
    - main_db_migrations
    - rabbitmq
    - jaeger
  volumes:
    - ./api:/app
    - ~/.config/gcloud:/tmp/.config/gcloud
    # - maven_cache:/app/.m2
    # use virtual volume if having issues with native binaries
    # - maven_target:/app/target
  environment:
    SERVICE: local
    FIREBASE_AUTH_EMULATOR_HOST: "firebase-emulator:9099"
    FIREBASE_STORAGE_EMULATOR_HOST: "firebase-emulator:9199"
    GCLOUD_PROJECT: "dissipate"
    REDIS_HOST: redis
    REDIS_PORT: 6379
    REDIS_PASSWORD: 98puOInkjbO&YiubkBt8guhvjhvredrg
    GOOGLE_APPLICATION_CREDENTIALS: /tmp/.config/gcloud/application_default_credentials.json
    QUARKUS_DATASOURCE_REACTIVE_URL: vertx-reactive:postgresql://postgresql:5432/dissipate
    QUARKUS_DATASOURCE_USERNAME: dissipate
    QUARKUS_DATASOURCE_PASSWORD: dissipate
    QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION: update
    QUARKUS_HTTP_HOST: 0.0.0.0
    QUARKUS_OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: http://jaeger:4317
  command:
    mvn
    quarkus:dev
    -Ddebug=true
    -DdebugHost=0.0.0.0

x-kafka-base: &kafka-base
  image: "wurstmeister/kafka:2.13-2.8.1"
  depends_on:
    - zookeeper

x-kafka-env: &kafka-env
  KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
  KAFKA_CREATE_TOPICS: "posts:3:1"
  KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INSIDE:PLAINTEXT,OUTSIDE:PLAINTEXT
  KAFKA_INTER_BROKER_LISTENER_NAME: INSIDE

services:
  api:
    image: api-server
    build:
      context: ./api
      dockerfile: src/main/docker/dev-jvm.dockerfile
    depends_on:
      - main_db
      - firebase-emulator
      - main_db_migrations
      - rabbitmq
      - jaeger
    volumes:
      - ./api:/app
      - ~/.config/gcloud:/tmp/.config/gcloud
      # - maven_cache:/app/.m2
      # use virtual volume if having issues with native binaries
      # - maven_target:/app/target
    environment:
      SERVICE: local
      FIREBASE_AUTH_EMULATOR_HOST: "firebase-emulator:9099"
      FIREBASE_STORAGE_EMULATOR_HOST: "firebase-emulator:9199"
      GCLOUD_PROJECT: "dissipate"
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: 98puOInkjbO&YiubkBt8guhvjhvredrg
      GOOGLE_APPLICATION_CREDENTIALS: /tmp/.config/gcloud/application_default_credentials.json
      QUARKUS_DATASOURCE_REACTIVE_URL: vertx-reactive:postgresql://postgresql:5432/dissipate
      QUARKUS_DATASOURCE_USERNAME: dissipate
      QUARKUS_DATASOURCE_PASSWORD: dissipate
      QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION: update
      QUARKUS_HTTP_HOST: 0.0.0.0
      QUARKUS_OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: http://jaeger:4317
      RABBITMQ_HOST: rabbitmq
    command:
      mvn
      quarkus:dev
      -Ddebug=true
      -Dquarkus.http.host=0.0.0.0
      -DdebugHost=0.0.0.0
      -P development
    ports:
      - "5005:5005"
      - "8080:8080"
      - "9299:9000"

  main_db:
    image: postgis/postgis
    restart: always
    environment:
      POSTGRES_USER: dissipate
      POSTGRES_PASSWORD: dissipate
      POSTGRES_DB: dissipate
    volumes:
      - main_db:/var/lib/postgresql/data
    ports:
      - "5433:5432"

  iam_db:
    image: postgres:latest
    restart: always
    environment:
      POSTGRES_USER: dissipate_iam
      POSTGRES_PASSWORD: dissipate_iam_pw
      POSTGRES_DB: dissipate_iam
    volumes:
      - iam_db:/var/lib/postgresql/data
    ports:
      - "5434:5432"

  # Jaeger
  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16685:16685"
      - "16686:16686"
      - "14268:14268"
      - "14250:14250"
      - "4317:4317"
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
      LOG_LEVEL: debug

  keycloak:
    image: quay.io/keycloak/keycloak:23.0.4
    environment:
      KC_FEATURES: authorization,token-exchange,docker,impersonation,scripts,web-authn,client-policies,dynamic-scopes
      KC_DB: postgres
      KC_DB_PASSWORD: dissipate_iam_pw
      KC_DB_SCHEMA: dissipate_iam
      KC_DB_URL: jdbc:postgresql://iam_db:5432/dissipate_iam?ssl=allow
      KC_DB_USERNAME: dissipate_iam
      KC_HOSTNAME: keycloak.local
      KC_HOSTNAME_STRICT: false
      KC_HTTPS_CLIENT_AUTH: request
      KC_HTTPS_KEY_STORE_FILE: /data/server.keystore
      KC_HTTPS_KEY_STORE_PASSWORD: KEYSTOREPASSWORD
      KC_HTTPS_PORT: 8443
      KC_HTTPS_PROTOCOLS: TLSv1.3,TLSv1.2
      KC_HTTPS_TRUST_STORE_FILE: /data/trust.keystore
      KC_HTTPS_TRUST_STORE_PASSWORD: TRUSTSTOREPASSWORD
      KC_HTTP_ENABLED: "true"
      KC_HTTP_PORT: 8081
      KC_METRICS_ENABLED: true
      KC_PROXY: edge
      KEYCLOAK_ADMIN: Admin
      KEYCLOAK_ADMIN_PASSWORD: Admin
      POSTGRES_DB: dissipate_iam
      POSTGRES_PASSWORD: dissipate_iam_pw
      POSTGRES_USER: dissipate_iam
      PROXY_ADDRESS_FORWARDING: true
    #DOCKER ENV KC_HTTPS_TRUST_STORE_FILE does not work
    #WorkAround is to add the TrustStore to the start up (Using Trust Store For AD LDAPS Certificate, you may not need this at all)
    entrypoint: /opt/keycloak/bin/kc.sh start --https-trust-store-file=${KC_HTTPS_TRUST_STORE_FILE} --https-trust-store-password=${KC_HTTPS_TRUST_STORE_PASSWORD}
    #entrypoint: /opt/keycloak/bin/kc.sh start --auto-build
    volumes:
      - ./data:/data:rw
    ports:
      - 8081:8081
      - 8443:8443
    depends_on:
      - iam_db

  firebase-emulator:
    image: andreysenov/firebase-tools
    volumes:
      - ./firebase-emulator/:/home/node
    ports:
      - "4000:4000"
      - "5001:5000"
      - "8085:8085"
      - "9000:9000"
      - "9005:9005"
      - "9099:9099"
      - "9199:9199"
    command: firebase emulators:start --project dissipate --import /home/node/data

#  redis:
#    image: "redis:alpine"
#    restart: always
#    ports:
#      - '6379:6379'
#    command: redis-server --save 20 1 --loglevel warning --requirepass 98puOInkjbO&YiubkBt8guhvjhvredrg

  main_db_migrations:
    image: api-server
    build:
      context: ./api
      dockerfile: src/main/docker/dev-jvm.dockerfile
    depends_on:
      - main_db
    volumes:
      - ./api:/app
      - maven_target:/app/target
      - maven_cache:/app/.m2
    command:
      - mvn
      - flyway:migrate
      - -Dflyway.url=jdbc:postgresql://main_db:5432/dissipate
      - -Dflyway.user=dissipate
      - -Dflyway.password=dissipate

  integration-tests:
    <<: *api-base
    command: mvn verify

#  kafka-server1:
#    <<: *kafka-base
#    ports:
#      - '29092:29092'
#    environment:
#      <<: *kafka-env
#      KAFKA_ADVERTISED_LISTENERS: INSIDE://kafka-server1:9092,OUTSIDE://localhost:29092
#      KAFKA_LISTENERS: INSIDE://kafka-server1:9092,OUTSIDE://kafka-server1:29092
#
#  kafka-cat-internal:
#    image: confluentinc/cp-kafkacat
#    entrypoint: "kafkacat"
#    command: "-b kafka-server1:9092 -L -v"
#    profiles: ["development"]
#
#  kafka-cat-external:
#    image: confluentinc/cp-kafkacat
#    entrypoint: "kafkacat"
#    command: "-b host.docker.internal:29092 -L -d all"
#    profiles: ["development"]
#
#  kafka-ui:
#    image: provectuslabs/kafka-ui:latest
#    ports:
#      - '8080:8080'
#    environment:
#      KAFKA_CLUSTERS_0_NAME: dclocal-cluster
#      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka-server1:9092
#    profiles: ["development"]

  rabbitmq:
    image: rabbitmq:3.11.3-management
    container_name: 'rabbitmq'
    ports:
      - 5672:5672
      - 15672:15672
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq/
      - rabbitmq_logs:/var/log/rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: dissipate
      RABBITMQ_DEFAULT_PASS: dissipate

  sonar-scanner:
    <<: *api-base
    command:
      - mvn
      - verify
      - sonar:sonar
      - -Dsonar.login=${SONAR_TOKEN}
      - -Dsonar.host.url=https://sonarcloud.io
      - -DGOOGLE_APPLICATION_CREDENTIALS=/app/cloudbuild_credentials.json
      - -e

#  zookeeper:
#    image: 'wurstmeister/zookeeper:latest'
#    ports:
#      - '22181:2181'
#    environment:
#      - ALLOW_ANONYMOUS_LOGIN=yes

volumes:
  main_db:
  iam_db:
  maven_cache:
  maven_target:
  rabbitmq_data:
  rabbitmq_logs:

