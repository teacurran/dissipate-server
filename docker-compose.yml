services:
  main-db:
    image: postgis/postgis
    restart: always
    environment:
      POSTGRES_USER: dissipate
      POSTGRES_PASSWORD: dissipate
      POSTGRES_DB: dissipate
    volumes:
      - postgres_db:/var/lib/postgresql/data
    ports:
      - "5442:5432"

  dse_seed_node:
    image: "datastax/dse-server:6.7.17"
    environment:
      - DS_LICENSE=accept
    # Allow DSE to lock memory with mlock
    links:
      - dse_opscenter
    cap_add:
      - IPC_LOCK
    ulimits:
      memlock: -1

  dse_node:
    image: "datastax/dse-server:6.7.17"
    environment:
      - DS_LICENSE=accept
      - SEEDS=dse_seed_node
    links:
      - dse_seed_node
      - dse_opscenter
    # Allow DSE to lock memory with mlock
    cap_add:
      - IPC_LOCK
    ulimits:
      memlock: -1

  dse_opscenter:
    image: "datastax/dse-opscenter:6.8.19"
    ports:
      - 8888:8888
    environment:
      - DS_LICENSE=accept

  firebase-emulator:
    image: firebase-emulator
    build:
      context: ./firebase-emulator
      dockerfile: ./Dockerfile
    volumes:
      - ./firebase-emulator/:/app/
    ports:
      - "4000:4000"
      - "5001:5000"
      - "9099:9099"
      - "9199:9199"
    command: firebase emulators:start --project dissipate --import /app/data

#  redis:
#    image: "redis:alpine"
#    restart: always
#    ports:
#      - '6379:6379'
#    command: redis-server --save 20 1 --loglevel warning --requirepass 98puOInkjbO&YiubkBt8guhvjhvredrg

  api:
    image: api-server
    build:
      context: ./api
      dockerfile: src/main/docker/dev-jvm.dockerfile
    depends_on:
      - main-db
    volumes:
      - ./api:/app
    environment:
      SERVICE: local
      FIREBASE_AUTH_EMULATOR_HOST: "firebase-emulator:9099"
      FIREBASE_STORAGE_EMULATOR_HOST: "firebase-emulator:9199"
      GCLOUD_PROJECT: "dissipate"
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: 98puOInkjbO&YiubkBt8guhvjhvredrg
    command:
      - mvn
      - -Dquarkus.datasource.reactive.url=vertx-reactive:postgresql://main-db:5432/dissipate;INIT=RUNSCRIPT FROM 'classpath:main-db-init.sql'
      - -Dquarkus.datasource.username=dissipate
      - -Dquarkus.datasource.password=dissipate
      - -Dquarkus.hibernate-orm.database.generation=update
      - -Dquarkus.http.host=0.0.0.0
      - quarkus:dev
    ports:
      - "8080:8080"

volumes:
  postgres_db: null
  cache: null
