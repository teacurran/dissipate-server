steps:
  - name: "gcr.io/cloud-builders/docker"
    id: 'pull cache'
    entrypoint: "bash"
    args:
      - -c
      - docker pull ${_ARTIFACT_REPO}/$PROJECT_ID/dissipate/dissipate-api:latest || exit 0

  - name: 'docker/compose:1.29.2'
    id: "tests in docker-compose"
    args: [
      'up',
      '--exit-code-from', 'integration-tests',
      'postgresql',
      'temporal-db',
      'temporal',
      'firebase-emulator',
      'integration-tests'
    ]
    env: [
      'COMPOSE_HTTP_TIMEOUT=400',
      'TEMPORAL_VERSION=1.17.5',
      'TEMPORAL_UI_VERSION=2.5.1',
      'TEMPORAL_WEB_VERSION=1.15.0',
      'POSTGRESQL_VERSION=13'
    ]

  - name: 'docker/compose:1.29.2'
    id: "sonar scan"
    args: [
      'up',
      '--exit-code-from', 'sonar-scanner',
      'postgresql',
      'temporal-db',
      'temporal',
      'firebase-emulator',
      'sonar-scanner'
    ]
    env: [
      'COMPOSE_HTTP_TIMEOUT=400',
      'TEMPORAL_VERSION=1.17.5',
      'TEMPORAL_UI_VERSION=2.5.1',
      'TEMPORAL_WEB_VERSION=1.15.0',
      'POSTGRESQL_VERSION=13'
    ]
    secretEnv: ['SONAR_TOKEN']

timeout: 5000s

options:
  machineType: 'E2_HIGHCPU_8'

images:
  - "${_ARTIFACT_REPO}/$PROJECT_ID/dissipate/dissipate-api:latest"
availableSecrets:
  secretManager:
    # - versionName: projects/$PROJECT_ID/secrets/SONAR_TOKEN/versions/1
    - versionName: projects/510014216261/secrets/SONAR_TOKEN/versions/1
      env: 'SONAR_TOKEN'
substitutions:
  _ARTIFACT_REPO: us-central1-docker.pkg.dev

