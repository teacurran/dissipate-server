steps:
  - name: "gcr.io/cloud-builders/docker"
    id: 'pull cache'
    entrypoint: "bash"
    args:
      - -c
      - docker pull ${_ARTIFACT_REPO}/$PROJECT_ID/dissipate/dissipate-api:latest || exit 0

  - name: "maven:3.8.6-amazoncorretto-18"
    id: "mvn package"
    dir: "api"
    entrypoint: mvn
    args:
      [
        '--batch-mode',
        '--update-snapshots',
        'package'
      ]

  - name: "maven:3.8.6-amazoncorretto-18"
    id: "mvn sonar"
    dir: "api"
    entrypoint: mvn
    args:
      [
        'clean',
        'verify',
        'sonar:sonar',
        '-Dsonar.login=$$SONAR_TOKEN',
        '-Dsonar.host.url="https://sonarcloud.io"',
      ]
    secretEnv: ['SONAR_TOKEN']

timeout: 5000s

options:
  machineType: 'E2_HIGHCPU_8'

images:
  - "${_ARTIFACT_REPO}/$PROJECT_ID/dissipate/dissipate-api:latest"
availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/SONAR_TOKEN/versions/1
      env: 'SONAR_TOKEN'
substitutions:
  _ARTIFACT_REPO: us-central1-docker.pkg.dev

